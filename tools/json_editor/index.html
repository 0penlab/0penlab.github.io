<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JSON编辑器</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
    }
    
    body {
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .toolbar {
      background-color: #f5f5f5;
      padding: 8px;
      display: flex;
      gap: 8px;
      border-bottom: 1px solid #ddd;
    }
    
    .toolbar button {
      padding: 4px 8px;
      background-color: #4285f4;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    
    .toolbar button:hover {
      background-color: #3367d6;
    }
    
    .toolbar button:disabled {
      background-color: #a0a0a0;
      cursor: not-allowed;
    }
    
    .file-input {
      display: none;
    }
    
    .container {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    
    .editor-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }
    
    .schema-container {
      width: 40%;
      border-left: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }
    
    .resizer {
      width: 5px;
      background-color: #ddd;
      cursor: col-resize;
    }
    
    .resizer:hover {
      background-color: #bbb;
    }
    
    .panel-header {
      padding: 6px 10px;
      background-color: #f5f5f5;
      font-weight: bold;
      border-bottom: 1px solid #ddd;
    }
    
    .editor-wrapper, .schema-wrapper {
      position: relative;
      flex: 1;
      overflow: hidden;
    }
    
    .line-numbers {
      position: absolute;
      top: 0;
      left: 0;
      width: 40px;
      height: 100%;
      background-color: #f5f5f5;
      border-right: 1px solid #ddd;
      overflow: hidden;
      text-align: right;
      padding: 6px 3px;
      color: #999;
      user-select: none;
    }
    
    .editor-area, .schema-area {
      position: absolute;
      top: 0;
      left: 40px;
      width: calc(100% - 40px);
      height: 100%;
      padding: 6px;
      border: none;
      resize: none;
      font-size: 13px;
      line-height: 1.5;
      tab-size: 2;
      overflow: auto;
      outline: none;
    }
    
    .status-bar {
      background-color: #f5f5f5;
      padding: 3px 10px;
      display: flex;
      justify-content: space-between;
      border-top: 1px solid #ddd;
      font-size: 12px;
    }
    
    .error {
      color: #d32f2f;
    }
    
    .valid {
      color: #388e3c;
    }
    
    /* 折叠功能样式 */
    .collapsed {
      position: relative;
      display: inline-block;
      padding: 0 5px;
      margin: 2px;
      background-color: #e3f2fd;
      border-radius: 3px;
      cursor: pointer;
    }
    
    /* 暗色模式 */
    @media (prefers-color-scheme: dark) {
      body {
        background-color: #1e1e1e;
        color: #ddd;
      }
      
      .toolbar, .panel-header, .line-numbers, .status-bar {
        background-color: #2d2d2d;
        border-color: #444;
        color: #ddd;
      }
      
      .editor-area, .schema-area {
        background-color: #1e1e1e;
        color: #ddd;
      }
      
      .resizer {
        background-color: #444;
      }
      
      .resizer:hover {
        background-color: #666;
      }
      
      .collapsed {
        background-color: #263238;
      }
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <button id="format-btn">格式化 (Ctrl+Shift+F)</button>
    <button id="validate-btn">验证 (Ctrl+Shift+V)</button>
    <button id="collapse-btn">折叠全部</button>
    <button id="expand-btn">展开全部</button>
    <button id="import-btn">导入文件</button>
    <button id="export-btn">导出文件</button>
    <input type="file" id="file-input" class="file-input" accept=".json,.jsonc,.json5">
  </div>

  <div class="container">
    <div class="editor-container">
      <div class="panel-header">JSON 编辑器</div>
      <div class="editor-wrapper">
        <div class="line-numbers" id="editor-line-numbers"></div>
        <textarea id="editor-area" class="editor-area" spellcheck="false">{
  "name": "JSON编辑器示例",
  "version": "1.0.0",
  "description": "一个简单的JSON编辑器",
  "features": [
    "格式化",
    "Schema校验",
    "行号显示",
    "可折叠"
  ],
  "isAwesome": true,
  "nested": {
    "value1": 123,
    "value2": "文本",
    "value3": null
  }
}</textarea>
      </div>
      <div class="status-bar">
        <span id="cursor-position">行: 1, 列: 1</span>
        <span id="validation-status"></span>
      </div>
    </div>
    
    <div class="resizer" id="resizer"></div>
    
    <div class="schema-container">
      <div class="panel-header">JSON Schema</div>
      <div class="schema-wrapper">
        <div class="line-numbers" id="schema-line-numbers"></div>
        <textarea id="schema-area" class="schema-area" spellcheck="false">{
  "type": "object",
  "properties": {
    "name": { "type": "string" },
    "version": { "type": "string" },
    "description": { "type": "string" },
    "features": { 
      "type": "array",
      "items": { "type": "string" }
    },
    "isAwesome": { "type": "boolean" },
    "nested": {
      "type": "object",
      "properties": {
        "value1": { "type": "number" },
        "value2": { "type": "string" },
        "value3": { "type": ["null", "string", "number"] }
      }
    }
  },
  "required": ["name", "version"]
}</textarea>
      </div>
      <div class="status-bar">
        <span id="schema-cursor-position">行: 1, 列: 1</span>
        <span id="schema-validation"></span>
      </div>
    </div>
  </div>

  <script src="ajv7.min.js"></script>
  <script>
    // 编辑器核心功能
    const editorArea = document.getElementById('editor-area');
    const schemaArea = document.getElementById('schema-area');
    const editorLineNumbers = document.getElementById('editor-line-numbers');
    const schemaLineNumbers = document.getElementById('schema-line-numbers');
    const cursorPosition = document.getElementById('cursor-position');
    const schemaCursorPosition = document.getElementById('schema-cursor-position');
    const validationStatus = document.getElementById('validation-status');
    const schemaValidation = document.getElementById('schema-validation');
    const formatBtn = document.getElementById('format-btn');
    const validateBtn = document.getElementById('validate-btn');
    const collapseBtn = document.getElementById('collapse-btn');
    const expandBtn = document.getElementById('expand-btn');
    const importBtn = document.getElementById('import-btn');
    const exportBtn = document.getElementById('export-btn');
    const fileInput = document.getElementById('file-input');
    const resizer = document.getElementById('resizer');
    
    // 初始化行号
    updateLineNumbers(editorArea, editorLineNumbers);
    updateLineNumbers(schemaArea, schemaLineNumbers);
    
    // 监听编辑器内容变化
    editorArea.addEventListener('input', function() {
      updateLineNumbers(editorArea, editorLineNumbers);
      validationStatus.textContent = '';
    });
    
    // 监听Schema内容变化
    schemaArea.addEventListener('input', function() {
      updateLineNumbers(schemaArea, schemaLineNumbers);
      schemaValidation.textContent = '';
    });
    
    // 监听编辑器光标位置变化
    editorArea.addEventListener('keyup', updateCursorPosition);
    editorArea.addEventListener('click', updateCursorPosition);
    
    // 监听Schema光标位置变化
    schemaArea.addEventListener('keyup', updateSchemaCursorPosition);
    schemaArea.addEventListener('click', updateSchemaCursorPosition);
    
    // Tab键处理
    editorArea.addEventListener('keydown', handleTabKey);
    schemaArea.addEventListener('keydown', handleTabKey);
    
    // 格式化按钮
    formatBtn.addEventListener('click', formatJSON);
    
    // 验证按钮
    validateBtn.addEventListener('click', validateJSON);
    
    // 折叠和展开按钮
    collapseBtn.addEventListener('click', collapseAll);
    expandBtn.addEventListener('click', expandAll);
    
    // 导入和导出按钮
    importBtn.addEventListener('click', () => fileInput.click());
    exportBtn.addEventListener('click', exportJSON);
    fileInput.addEventListener('change', importJSON);
    
    // 快捷键
    document.addEventListener('keydown', function(e) {
      // Ctrl+Shift+F：格式化
      if (e.ctrlKey && e.shiftKey && e.key === 'F') {
        e.preventDefault();
        formatJSON();
      }
      
      // Ctrl+Shift+V：验证
      if (e.ctrlKey && e.shiftKey && e.key === 'V') {
        e.preventDefault();
        validateJSON();
      }
    });
    
    // 调整分割栏
    let isResizing = false;
    let initialX = 0;
    let initialWidth = 0;
    
    resizer.addEventListener('mousedown', function(e) {
      isResizing = true;
      initialX = e.clientX;
      initialWidth = document.querySelector('.schema-container').offsetWidth;
      document.addEventListener('mousemove', handleResize);
      document.addEventListener('mouseup', stopResize);
    });
    
    function handleResize(e) {
      if (!isResizing) return;
      const container = document.querySelector('.container');
      const schemaContainer = document.querySelector('.schema-container');
      const deltaX = e.clientX - initialX;
      const newWidth = Math.max(150, Math.min(container.offsetWidth - 150, initialWidth - deltaX));
      schemaContainer.style.width = newWidth + 'px';
    }
    
    function stopResize() {
      isResizing = false;
      document.removeEventListener('mousemove', handleResize);
      document.removeEventListener('mouseup', stopResize);
    }
    
    // 格式化JSON
    function formatJSON() {
      try {
        const json = JSON.parse(editorArea.value);
        editorArea.value = JSON.stringify(json, null, 2);
        updateLineNumbers(editorArea, editorLineNumbers);
        validationStatus.textContent = '格式化成功';
        validationStatus.className = 'valid';
      } catch (error) {
        validationStatus.textContent = '无效的JSON: ' + error.message;
        validationStatus.className = 'error';
      }
    }
    
    // 验证JSON
    function validateJSON() {
      try {
        const json = JSON.parse(editorArea.value);
        
        try {
          const schema = JSON.parse(schemaArea.value);
          const ajv = new window.Ajv();
          const validate = ajv.compile(schema);
          const valid = validate(json);
          
          if (valid) {
            validationStatus.textContent = 'JSON 验证通过';
            validationStatus.className = 'valid';
          } else {
            validationStatus.textContent = 'Schema 验证失败: ' + ajv.errorsText(validate.errors);
            validationStatus.className = 'error';
          }
        } catch (schemaError) {
          schemaValidation.textContent = '无效的Schema: ' + schemaError.message;
          schemaValidation.className = 'error';
        }
      } catch (error) {
        validationStatus.textContent = '无效的JSON: ' + error.message;
        validationStatus.className = 'error';
      }
    }
    
    // 更新行号
    function updateLineNumbers(textarea, lineNumbersElement) {
      const lines = textarea.value.split('\n');
      const count = lines.length;
      
      let lineNumbersHTML = '';
      for (let i = 1; i <= count; i++) {
        lineNumbersHTML += i + '<br>';
      }
      
      lineNumbersElement.innerHTML = lineNumbersHTML;
      
      // 调整高度以适应内容
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    }
    
    // 处理Tab键
    function handleTabKey(e) {
      if (e.key === 'Tab') {
        e.preventDefault();
        const start = this.selectionStart;
        const end = this.selectionEnd;
        
        this.value = this.value.substring(0, start) + '  ' + this.value.substring(end);
        this.selectionStart = this.selectionEnd = start + 2;
      }
    }
    
    // 更新光标位置
    function updateCursorPosition() {
      const position = getCursorPosition(editorArea);
      cursorPosition.textContent = `行: ${position.line}, 列: ${position.column}`;
    }
    
    // 更新Schema光标位置
    function updateSchemaCursorPosition() {
      const position = getCursorPosition(schemaArea);
      schemaCursorPosition.textContent = `行: ${position.line}, 列: ${position.column}`;
    }
    
    // 获取光标位置
    function getCursorPosition(textarea) {
      const value = textarea.value;
      const selectionStart = textarea.selectionStart;
      
      let line = 1;
      let column = 1;
      
      for (let i = 0; i < selectionStart; i++) {
        if (value[i] === '\n') {
          line++;
          column = 1;
        } else {
          column++;
        }
      }
      
      return { line, column };
    }
    
    // JSON折叠功能
    function collapseAll() {
      try {
        const json = JSON.parse(editorArea.value);
        editorArea.value = JSON.stringify(json);
        updateLineNumbers(editorArea, editorLineNumbers);
        validationStatus.textContent = '已折叠所有节点';
      } catch (error) {
        validationStatus.textContent = '无效的JSON: ' + error.message;
        validationStatus.className = 'error';
      }
    }
    
    // JSON展开功能
    function expandAll() {
      try {
        const json = JSON.parse(editorArea.value);
        editorArea.value = JSON.stringify(json, null, 2);
        updateLineNumbers(editorArea, editorLineNumbers);
        validationStatus.textContent = '已展开所有节点';
      } catch (error) {
        validationStatus.textContent = '无效的JSON: ' + error.message;
        validationStatus.className = 'error';
      }
    }
    
    // 导入JSON
    function importJSON(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        editorArea.value = e.target.result;
        updateLineNumbers(editorArea, editorLineNumbers);
        formatJSON();
      };
      reader.readAsText(file);
    }
    
    // 导出JSON
    function exportJSON() {
      try {
        const json = JSON.parse(editorArea.value);
        const formattedJson = JSON.stringify(json, null, 2);
        
        const blob = new Blob([formattedJson], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = 'exported-json.json';
        a.click();
        
        URL.revokeObjectURL(url);
      } catch (error) {
        validationStatus.textContent = '无效的JSON: ' + error.message;
        validationStatus.className = 'error';
      }
    }
    
    // 初始化
    updateCursorPosition();
    updateSchemaCursorPosition();
  </script>
</body>
</html>
